package processor

import (
	"os"
	"testing"

	"github.com/Jeffail/benthos/lib/log"
	"github.com/Jeffail/benthos/lib/message"
	"github.com/Jeffail/benthos/lib/metrics"
)

func TestAtlas(t *testing.T) {
	tLog := log.New(os.Stdout, log.Config{LogLevel: "ERROR"})
	tStats := metrics.DudType{}

	type gTest struct {
		name   string
		input  string
		output string
	}

	tests := []gTest{
		{
			name:   "unparsed",
			input:  `"Aug 22 15:18:32 atl2.shared.phx2.websys.tmcs atlas: syncwait,15:18:32.960,0x2b4e399dea80,W3cyasCoOhcAABRp3CcAAAjN,4,3000,FINISH"`,
			output: `{"command_type":"syncwait","hostname":"atl2.shared.phx2.websys.tmcs","ts":"2018-08-22T15:18:32Z","command":{"unparsed":"syncwait,15:18:32.960,0x2b4e399dea80,W3cyasCoOhcAABRp3CcAAAjN,4,3000,FINISH"}}`,
		},
		{
			name:   "opuse",
			input:  `"Aug 22 14:54:35 atl3.shared.ash1.websys.tmcs atlas: opuse,14:54:35.450,14:54:35\tCH6\\6\\CartOps\\0\\0\\10\\8\\406347\\406361\\0\\100\\9"`,
			output: `{"command_type":"opuse","hostname":"atl3.shared.ash1.websys.tmcs","ts":"2018-08-22T14:54:35Z","command":{"opuse":{"log_time":"14:54:35.450","vax_time":"14:54:35","host":"CH6","portset":6,"usage":"CartOps","usedcur":0,"quecur":0,"usedpeak":10,"quepeak":8,"usedtot":406347,"quetot":406361,"min":0,"max":100,"ideal":9}}}`,
		},
		{
			name:   "an error",
			input:  `"Aug 22 14:19:29 atl2.shared.ash2.websys.tmcs atlas: error,13:42:56.960,0000016A|{\"header\":{\"result\":\"0x100085\",\"statmsg\":\"FAIL\",\"statcode\":\"0x100085\",\"cache\":0,\"mode\":10,\"quenum\":\"0x0\",\"quewait\":0,\"querate\":0,\"sid\":\"W3x5UMCoLv8AABpgh9kAABbK\",\"bid\":\"pidW3x5UMCoLv8AABpgh9kAABbK\",\"cip\":\"192.168.47.47\",\"token\":0,\"duration\":\"1.45\",\"transaction_id\":\"TMSSRANDID3546650715477047672736441738870211685116\",\"uid\":\"W3x5UMCoLh0AAA1YQTYAABG7\"}}"`,
			output: `{"command_type":"error","hostname":"atl2.shared.ash2.websys.tmcs","ts":"2018-08-22T14:19:29Z","command":{"error":{"log_time":"13:42:56.960","message_length_hex":"0000016A","message":{"header":{"bid":"pidW3x5UMCoLv8AABpgh9kAABbK","cache":0,"cip":"192.168.47.47","duration":"1.45","mode":10,"quenum":"0x0","querate":0,"quewait":0,"result":"0x100085","sid":"W3x5UMCoLv8AABpgh9kAABbK","statcode":"0x100085","statmsg":"FAIL","token":0,"transaction_id":"TMSSRANDID3546650715477047672736441738870211685116","uid":"W3x5UMCoLh0AAA1YQTYAABG7"}}}}}`,
		},
		{
			name:   "response parsing with json",
			input:  `"Aug 21 10:51:02 atl2.tmol.phx2.websys.tmcs atlas: response,10:51:02.620,363776339/192.168.48.45/52401/414,00000BDF|{\"header\":{\"result\":\"0x0\",\"statmsg\":\"PASS\",\"statcode\":\"0x0\",\"cache\":0,\"mode\":10,\"quenum\":\"0x0\",\"quewait\":0,\"querate\":0,\"sid\":\"c747ae23-a261-4d80-802e-68b\",\"bid\":\"93fee8a4-7a26-42bc-ac30\",\"cip\":\"173.56.71.83\",\"token\":\"0000000208190804000084029031A8C000000000025407D5EFE9D435\"},\"command1\":{\"cmd\":\"release_print_flag\",\"ref\":null,\"result\":\"0x0\",\"resultcode\":\"0x0\",\"vax\":\"ARZ\"},\"command2\":{\"cmd\":\"print_tf_ticket\",\"ref\":null,\"result\":\"0x0\",\"resultcode\":\"0x0\",\"vax\":\"ARZ\",\"tickets\":[{\"ticketnum\":1,\"sysid\":\"ARZ\",\"extra1\":null,\"extra2\":null,\"address\":null,\"city\":null,\"zip\":null,\"phone\":null,\"acct_date\":null,\"creator_code\":null,\"venue\":0,\"venue_name\":null,\"Ticket_text1\":null,\"Ticket_text2\":null,\"Ticket_text3\":null,\"Ticket_text4\":null,\"Ticket_text5\":null,\"Ticket_text6\":null,\"service_phone\":null,\"will_call\":0,\"major_cat\":0,\"minor_cat\":0,\"Ticket1_C\":\" 5       34  15     ADULT  \",\"Ticket1_L\":\"WD0913 \",\"Ticket1_R\":\"EWD0913  \",\"Ticket2_C\":\" MAIN CONCOURSE      85.00 \",\"Ticket2_L\":\"  85.00\",\"Ticket2_R\":\"CN 32138 \",\"Ticket3_C\":\"    LIVE NATION PRESENTS   \",\"Ticket3_L\":\"  17.50\",\"Ticket3_R\":\"MC 859   \",\"Ticket4_C\":\"      NINE INCH NAILS      \",\"Ticket4_L\":\" 5     \",\"Ticket4_R\":\" 5       \",\"Ticket5_C\":\"        WWW.NIN.COM        \",\"Ticket5_L\":\"MC  19X\",\"Ticket5_R\":\" 576ZIP  \",\"Ticket6_C\":\"  THE JESUS AND MARY CHAIN \",\"Ticket6_L\":\" 34  15\",\"Ticket6_R\":\"     34  \",\"Ticket7_C\":\"      COMERICA THEATRE     \",\"Ticket7_L\":\"576AZIP\",\"Ticket7_R\":\"A  85.00 \",\"Ticket8_C\":\"  THU SEP 13 2018 7:00 PM  \",\"Ticket8_L\":\"A21AUG8\",\"Ticket8_R\":\"     15  \",\"acctnum\":\"13-51641\",\"barcode\":\"XXXXXXXXXXXXXXXX\",\"custname\":\"CARBONELL \\\\NICHOLAS\\\\\\\\\\\\\",\"evcode\":\"EWD0913\",\"exit_portal\":\"MAIN CONCOURSE\",\"face\":\"81.50\",\"face_fc_cc\":\"102.50\",\"row\":\"34\",\"seat\":\"15\",\"section\":\"5\"},{\"ticketnum\":2,\"sysid\":\"ARZ\",\"extra1\":null,\"extra2\":null,\"address\":null,\"city\":null,\"zip\":null,\"phone\":null,\"acct_date\":null,\"creator_code\":null,\"venue\":0,\"venue_name\":null,\"Ticket_text1\":null,\"Ticket_text2\":null,\"Ticket_text3\":null,\"Ticket_text4\":null,\"Ticket_text5\":null,\"Ticket_text6\":null,\"service_phone\":null,\"will_call\":0,\"major_cat\":0,\"minor_cat\":0,\"Ticket1_C\":\" 5       34  14     ADULT  \",\"Ticket1_L\":\"WD0913 \",\"Ticket1_R\":\"EWD0913  \",\"Ticket2_C\":\" MAIN CONCOURSE      85.00 \",\"Ticket2_L\":\"  85.00\",\"Ticket2_R\":\"CN 20618 \",\"Ticket3_C\":\"    LIVE NATION PRESENTS   \",\"Ticket3_L\":\"  17.50\",\"Ticket3_R\":\"MC 859   \",\"Ticket4_C\":\"      NINE INCH NAILS      \",\"Ticket4_L\":\" 5     \",\"Ticket4_R\":\" 5       \",\"Ticket5_C\":\"        WWW.NIN.COM        \",\"Ticket5_L\":\"MC  19X\",\"Ticket5_R\":\" 576ZIP  \",\"Ticket6_C\":\"  THE JESUS AND MARY CHAIN \",\"Ticket6_L\":\" 34  14\",\"Ticket6_R\":\"     34  \",\"Ticket7_C\":\"      COMERICA THEATRE     \",\"Ticket7_L\":\"576AZIP\",\"Ticket7_R\":\"A  85.00 \",\"Ticket8_C\":\"  THU SEP 13 2018 7:00 PM  \",\"Ticket8_L\":\"A21AUG8\",\"Ticket8_R\":\"     14  \",\"acctnum\":\"13-51641\",\"barcode\":\"XXXXXXXXXXXXXXXX\",\"custname\":\"CARBONELL \\\\NICHOLAS\\\\\\\\\\\\\",\"evcode\":\"EWD0913\",\"exit_portal\":\"MAIN CONCOURSE\",\"face\":\"81.50\",\"face_fc_cc\":\"102.50\",\"row\":\"34\",\"seat\":\"14\",\"section\":\"5\"}]}}"`,
			output: `{"command_type":"response","hostname":"atl2.tmol.phx2.websys.tmcs","ts":"2018-08-21T10:51:02Z","command":{"response":{"log_time":"10:51:02.620","client":{"message":363776339,"ip":"192.168.48.45","port":52401,"socket":414},"message_length_hex":"00000BDF","message":{"header":{"command1":{"cmd":"release_print_flag","ref":null,"result":"0x0","resultcode":"0x0","vax":"ARZ"},"command2":{"cmd":"print_tf_ticket","ref":null,"result":"0x0","resultcode":"0x0","tickets":[{"Ticket1_C":" 5       34  15     ADULT  ","Ticket1_L":"WD0913 ","Ticket1_R":"EWD0913  ","Ticket2_C":" MAIN CONCOURSE      85.00 ","Ticket2_L":"  85.00","Ticket2_R":"CN 32138 ","Ticket3_C":"    LIVE NATION PRESENTS   ","Ticket3_L":"  17.50","Ticket3_R":"MC 859   ","Ticket4_C":"      NINE INCH NAILS      ","Ticket4_L":" 5     ","Ticket4_R":" 5       ","Ticket5_C":"        WWW.NIN.COM        ","Ticket5_L":"MC  19X","Ticket5_R":" 576ZIP  ","Ticket6_C":"  THE JESUS AND MARY CHAIN ","Ticket6_L":" 34  15","Ticket6_R":"     34  ","Ticket7_C":"      COMERICA THEATRE     ","Ticket7_L":"576AZIP","Ticket7_R":"A  85.00 ","Ticket8_C":"  THU SEP 13 2018 7:00 PM  ","Ticket8_L":"A21AUG8","Ticket8_R":"     15  ","Ticket_text1":null,"Ticket_text2":null,"Ticket_text3":null,"Ticket_text4":null,"Ticket_text5":null,"Ticket_text6":null,"acct_date":null,"acctnum":"13-51641","address":null,"barcode":"XXXXXXXXXXXXXXXX","city":null,"creator_code":null,"custname":"CARBONELL \\NICHOLAS\\\\\\","evcode":"EWD0913","exit_portal":"MAIN CONCOURSE","extra1":null,"extra2":null,"face":"81.50","face_fc_cc":"102.50","major_cat":0,"minor_cat":0,"phone":null,"row":"34","seat":"15","section":"5","service_phone":null,"sysid":"ARZ","ticketnum":1,"venue":0,"venue_name":null,"will_call":0,"zip":null},{"Ticket1_C":" 5       34  14     ADULT  ","Ticket1_L":"WD0913 ","Ticket1_R":"EWD0913  ","Ticket2_C":" MAIN CONCOURSE      85.00 ","Ticket2_L":"  85.00","Ticket2_R":"CN 20618 ","Ticket3_C":"    LIVE NATION PRESENTS   ","Ticket3_L":"  17.50","Ticket3_R":"MC 859   ","Ticket4_C":"      NINE INCH NAILS      ","Ticket4_L":" 5     ","Ticket4_R":" 5       ","Ticket5_C":"        WWW.NIN.COM        ","Ticket5_L":"MC  19X","Ticket5_R":" 576ZIP  ","Ticket6_C":"  THE JESUS AND MARY CHAIN ","Ticket6_L":" 34  14","Ticket6_R":"     34  ","Ticket7_C":"      COMERICA THEATRE     ","Ticket7_L":"576AZIP","Ticket7_R":"A  85.00 ","Ticket8_C":"  THU SEP 13 2018 7:00 PM  ","Ticket8_L":"A21AUG8","Ticket8_R":"     14  ","Ticket_text1":null,"Ticket_text2":null,"Ticket_text3":null,"Ticket_text4":null,"Ticket_text5":null,"Ticket_text6":null,"acct_date":null,"acctnum":"13-51641","address":null,"barcode":"XXXXXXXXXXXXXXXX","city":null,"creator_code":null,"custname":"CARBONELL \\NICHOLAS\\\\\\","evcode":"EWD0913","exit_portal":"MAIN CONCOURSE","extra1":null,"extra2":null,"face":"81.50","face_fc_cc":"102.50","major_cat":0,"minor_cat":0,"phone":null,"row":"34","seat":"14","section":"5","service_phone":null,"sysid":"ARZ","ticketnum":2,"venue":0,"venue_name":null,"will_call":0,"zip":null}],"vax":"ARZ"},"header":{"bid":"93fee8a4-7a26-42bc-ac30","cache":0,"cip":"173.56.71.83","mode":10,"quenum":"0x0","querate":0,"quewait":0,"result":"0x0","sid":"c747ae23-a261-4d80-802e-68b","statcode":"0x0","statmsg":"PASS","token":"0000000208190804000084029031A8C000000000025407D5EFE9D435"}}}}}}`,
		},
		{
			name:   "response parsing with json 2",
			input:  `"Aug 21 12:03:55 atl1.shared.phx2.websys.tmcs atlas: response,12:03:55.460,42854398/192.168.49.220/2175/429,00000BDE|{\"header\":{\"result\":\"0x0\",\"statmsg\":\"PASS\",\"statcode\":\"0x0\",\"cache\":0,\"mode\":10,\"quenum\":\"0x0\",\"quewait\":0,\"querate\":0,\"sid\":\"SYSTEMCALL\",\"bid\":\"randbid1050567ec74cd68\",\"cip\":\"192.168.48.45\",\"token\":\"00000001042E00000011D68EEB30A8C0000000000296C556EFE90000\",\"duration\":\"16.07\",\"transaction_id\":\"ismds;seq=540077;ts=2018-08-21T19:03:55.088Z\",\"uid\":\"W3xiG8CoMb8AAC3BMeIAABHL\"},\"command1\":{\"cmd\":\"get_enabled_types\",\"ref\":null,\"result\":\"0x0\",\"resultcode\":\"0x0\",\"vax\":\"NV2\",\"opset\":0,\"evcode\":\"EI81106L\",\"evid\":\"2E0052DEE65B1FAB\",\"opcode\":\"ZIZ127\",\"is_refund\":0,\"exttt\":[\"000000000002\",\"000000190004\",\"0000001A0004\",\"000000180004\",\"0000001F0004\",\"000006160004\",\"0000001B0004\",\"0000001E0004\",\"000004170004\"]},\"command2\":{\"cmd\":\"get_event_fees\",\"ref\":null,\"result\":\"0x0\",\"resultcode\":\"0x0\",\"vax\":\"NV2\",\"opset\":0,\"evcode\":\"EI81106L\",\"evid\":\"2E0052DEE65B1FAB\",\"opcode\":\"ZIZ127\",\"mop\":\"ACCN  \",\"event_revision\":389,\"exttts\":[\"000000000001\",\"000000000002\",\"000000000003\",\"000000000004\",\"000000000005\",\"000000000006\",\"000000000007\",\"000000000008\",\"000000000009\",\"00000000000A\",\"00000000000B\",\"00000000000C\",\"000000190004\",\"0000001A0004\",\"000000180004\",\"0000001F0004\",\"000006160004\",\"0000001B0004\",\"0000001E0004\",\"000004170004\"],\"price_levels\":[1,2,3,4],\"svc\":[[13.29,14.05,327.50,327.50,327.50,327.50,327.50,327.50,13.49,327.50,327.50,327.50,13.30,13.05,13.05,0.00,14.05,13.05,12.03,14.65],[11.70,13.20,327.50,327.50,327.50,327.50,327.50,327.50,12.64,327.50,327.50,327.50,0.00,11.68,11.68,0.00,13.20,11.68,0.00,0.00],[11.70,13.07,327.50,327.50,327.50,327.50,327.50,327.50,12.49,327.50,327.50,327.50,11.88,11.68,11.68,13.35,0.00,11.68,0.00,0.00],[11.20,11.74,327.50,327.50,327.50,327.50,327.50,327.50,11.20,327.50,327.50,327.50,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00]],\"distance_charge\":[[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00]],\"svc_tax\":[[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00]],\"svc_tax2\":[[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00]]}}"`,
			output: `{"command_type":"response","hostname":"atl1.shared.phx2.websys.tmcs","ts":"2018-08-21T12:03:55Z","command":{"response":{"log_time":"12:03:55.460","client":{"message":42854398,"ip":"192.168.49.220","port":2175,"socket":429},"message_length_hex":"00000BDE","message":{"header":{"command1":{"cmd":"get_enabled_types","evcode":"EI81106L","evid":"2E0052DEE65B1FAB","exttt":["000000000002","000000190004","0000001A0004","000000180004","0000001F0004","000006160004","0000001B0004","0000001E0004","000004170004"],"is_refund":0,"opcode":"ZIZ127","opset":0,"ref":null,"result":"0x0","resultcode":"0x0","vax":"NV2"},"command2":{"cmd":"get_event_fees","distance_charge":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"evcode":"EI81106L","event_revision":389,"evid":"2E0052DEE65B1FAB","exttts":["000000000001","000000000002","000000000003","000000000004","000000000005","000000000006","000000000007","000000000008","000000000009","00000000000A","00000000000B","00000000000C","000000190004","0000001A0004","000000180004","0000001F0004","000006160004","0000001B0004","0000001E0004","000004170004"],"mop":"ACCN  ","opcode":"ZIZ127","opset":0,"price_levels":[1,2,3,4],"ref":null,"result":"0x0","resultcode":"0x0","svc":[[13.29,14.05,327.5,327.5,327.5,327.5,327.5,327.5,13.49,327.5,327.5,327.5,13.3,13.05,13.05,0,14.05,13.05,12.03,14.65],[11.7,13.2,327.5,327.5,327.5,327.5,327.5,327.5,12.64,327.5,327.5,327.5,0,11.68,11.68,0,13.2,11.68,0,0],[11.7,13.07,327.5,327.5,327.5,327.5,327.5,327.5,12.49,327.5,327.5,327.5,11.88,11.68,11.68,13.35,0,11.68,0,0],[11.2,11.74,327.5,327.5,327.5,327.5,327.5,327.5,11.2,327.5,327.5,327.5,0,0,0,0,0,0,0,0]],"svc_tax":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"svc_tax2":[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"vax":"NV2"},"header":{"bid":"randbid1050567ec74cd68","cache":0,"cip":"192.168.48.45","duration":"16.07","mode":10,"quenum":"0x0","querate":0,"quewait":0,"result":"0x0","sid":"SYSTEMCALL","statcode":"0x0","statmsg":"PASS","token":"00000001042E00000011D68EEB30A8C0000000000296C556EFE90000","transaction_id":"ismds;seq=540077;ts=2018-08-21T19:03:55.088Z","uid":"W3xiG8CoMb8AAC3BMeIAABHL"}}}}}}`,
		},
		{
			name:   "response parsing without json",
			input:  `"Aug 21 10:52:07 atl1.tmol.ash2.websys.tmcs atlas: response,10:52:07.630,195840581/192.168.59.44/49312/416,000000EA|result=0x0,statmsg=QUE,statcode=0x0,cache=1,mode=12,quenum=0x1,quewait=0,querate=122,sid=747152a6865a4b7ca80f1336,bid=66a4a1e1ba9e413286b38e52,cip=47.39.241.192,token=0000000108020003001B480F903AA8C00000000002550A4EEFE9E7B7;"`,
			output: `{"command_type":"response","hostname":"atl1.tmol.ash2.websys.tmcs","ts":"2018-08-21T10:52:07Z","command":{"response":{"log_time":"10:52:07.630","client":{"message":195840581,"ip":"192.168.59.44","port":49312,"socket":416},"message_length_hex":"000000EA","message":{"header":{"bid":"66a4a1e1ba9e413286b38e52","cache":1,"cip":"47.39.241.192","mode":12,"quenum":"0x1","querate":122,"quewait":0,"result":"0x0","sid":"747152a6865a4b7ca80f1336","statcode":"0x0","statmsg":"QUE","token":"0000000108020003001B480F903AA8C00000000002550A4EEFE9E7B7"}}}}}`,
		},
		{
			name:   "response parsing without json 2",
			input:  `"Aug 23 11:31:33 atl2.tmol.phx1.websys.tmcs atlas: response,11:31:33.220,414413858/192.168.46.156/40167/416,0000014D|result=0x0,statmsg=PASS,statcode=0x0,cache=1,mode=11,quenum=0x0,quewait=0,querate=0,sid=7884d7814cfd4b29908eb377,bid=eef14ddf6dea46dda528cebf,cip=129.176.151.14,token=0000000208190003002A2E87902FA8C00000000002791D76EFE9FE3F|cmd=0x1,ref=null,result=0x201033,resultcode=0x1201033,vax=ARZ,evcode=EWA0908,evid=19005394EE7E2ECB;"`,
			output: `{"command_type":"response","hostname":"atl2.tmol.phx1.websys.tmcs","ts":"2018-08-23T11:31:33Z","command":{"response":{"log_time":"11:31:33.220","client":{"message":414413858,"ip":"192.168.46.156","port":40167,"socket":416},"message_length_hex":"0000014D","message":{"command1":{"cmd":"0x1","evcode":"EWA0908","evid":"19005394EE7E2ECB","ref":"null","result":"0x201033","resultcode":"0x1201033","vax":"ARZ"},"header":{"bid":"eef14ddf6dea46dda528cebf","cache":1,"cip":"129.176.151.14","mode":11,"quenum":"0x0","querate":0,"quewait":0,"result":"0x0","sid":"7884d7814cfd4b29908eb377","statcode":"0x0","statmsg":"PASS","token":"0000000208190003002A2E87902FA8C00000000002791D76EFE9FE3F"}}}}}`,
		},
		{
			name:   "host load",
			input:  `"Aug 23 13:24:05 atl2.tmol.ash2.websys.tmcs atlas: hostload,13:24:05.630,ARZ,0,13:24:04,29"`,
			output: `{"command_type":"hostload","hostname":"atl2.tmol.ash2.websys.tmcs","ts":"2018-08-23T13:24:05Z","command":{"hostload":{"log_time":"13:24:05.630","vax":"ARZ","load":0,"vax_time":"13:24:04","flags":29}}}`,
		},
	}

	for _, test := range tests {
		conf := NewConfig()
		conf.Atlas.Parts = []int{0}

		aSet, err := NewAtlas(conf, nil, tLog, tStats)
		if err != nil {
			t.Fatalf("Error for test '%v': %v", test.name, err)
		}

		inMsg := message.New(
			[][]byte{
				[]byte(test.input),
			},
		)
		msgs, _ := aSet.ProcessMessage(inMsg)
		if len(msgs) != 1 {
			t.Fatalf("Test '%v' did not succeed", test.name)
		}

		if exp, act := test.output, string(message.GetAllBytes(msgs[0])[0]); exp != act {
			t.Errorf("Wrong result '%v': \n%v\n != \n%v", test.name, act, exp)
		}
	}
}
